/* angular-data-depend - v1.0.0 - 2013-08-01 | (c) 2013 Nico Rehwaldt | MIT */
!function(a){function b(a){function b(a){return e(a)?a:[a]}function c(a){return Array.prototype.slice.apply(a)}var d=a.module("dataDepend",[]),e=a.isArray,f=a.isFunction,g=(a.isObject,a.forEach);a.extend;var h=["$rootScope","$q",function(a,b){function c(a){function c(c){function d(a){var b=C.value;C.$loaded=!0,z=!1,b!==a&&(C.value=a,r("setLoaded",b," -> ",a),k())}function e(a){var b=x[a];return b||(x[a]=b={}),b}function f(){C.$loaded=!1,A=!1}function h(a){var b=t[a];if(!b)throw new Error("[dataDepend] No provider for "+a);return b}function i(a){g(y,a)}function j(a){g(u,a)}function k(){i(function(a){a.parentChanged()})}function l(){function a(a,b){var c=e(a),d=c.value;r("resolveDependencies",a,":",d,"->",b),d!==b&&(r("resolveDependencies","changed"),c.value=b,z=!0)}var c=[];return j(function(b){var d=h(b),e=d.resolve().then(function(c){return a(b,c),c});c.push(e)}),b.all(c).then(function(){var b=[];return j(function(c){var d=h(c).get();a(c,d),b.push(d)}),b})}function m(a){f(),r("asyncLoad: init load");var b=l().then(function(c){if(r("asyncLoad dependencies resolved",c),B!==b)return r("asyncLoad: skip (new load request)"),B;var d=o();return v&&(z||a||0==c.length)&&(r("asyncLoad: call factory"),d=v.apply(v,c)),d}).then(function(a){return B!==b?(r("asyncLoad: skip (new load request)"),B):(r("asyncLoad: load complete"),B=null,d(a),a)});return b}function n(){return r("parentChanged START"),B?(r("parentChanged SKIP (loading)"),void 0):(A=!0,w&&(r("parentChanged RESOLVE async"),a(function(){r("parentChanged RESOLVE"),p()})),k(),void 0)}function o(){return C.value}function p(a){a=a||{};var c=a.reload;return(A||c)&&(B=m(c)),B?(r("resolve: load async"),B):(r("resolve: load sync"),b.when(o()))}function q(a){if(v)throw new Error("[dataDepend] Cannot set value, was using factory");d(a)}function r(){}c=c||{};var s=c.produces,t=c.registry,u=c.dependencies||[],v=c.factory,w=c.eager||!1,x={},y=[],z=!0,A=!0,B=null,C={$loaded:!1},D={produces:s,data:C,get:o,set:q,resolve:p,children:y,parentChanged:n};return j(function(a){h(a).children.push(D)}),w&&(r("resolve async"),a(function(){r("resolve"),p()})),v||d(c.value),D}return{create:c}}return c(function(b){a.$evalAsync(b)})}],i=["$rootScope","$injector","dataProviderFactory",function(d,h,i){function j(d){function h(){function h(a,c){var g="provider$"+m++;if(c?a=b(a):(c=a,a=d(c),e(c)&&(c=c[c.length-1])),!f(c))throw new Error('[dataDepend] Must provide callback as second parameter or use [ "A", "B", function(a, b) { } ] notation');var h=j({produces:g,factory:c,dependencies:a,eager:!0,registry:n});return h.data}function j(b){var d,f=b.produces;if(!f)throw new Error("[dataDepend] Must provide produces when creating new provider");if(d=i.create(b),e(f)){var h=d.get,j=d.resolve;g(f,function(b,e){function f(a){return a?a[e]:a}n[b]=a.extend({},d,{resolve:function(){var a=c(arguments);return j.apply(null,a).then(f)},get:function(){var a=c(arguments);return f(h.apply(null,a))}})})}else n[f]=d;return d}function k(a,b){var c,g,h=n[a];if(h)return h.set(b),void 0;(f(b)||e(b))&&(c=b,g=d(c),b=void 0,e(c)&&(c=c[c.length-1]));var h=j({produces:a,factory:c,value:b,dependencies:g,registry:n});return h.data}function l(a){var b=n[a];if(!b)throw new Error('[dataDepend] Provider "'+a+'" does not exists');b.resolve({reload:!0})}var m=0,n={};return{$providers:n,get:h,set:k,changed:l}}return{create:h}}return j(h.annotate,function(a){d.$evalAsync(a)})}];return d.factory("dataDependFactory",i),d.factory("dataProviderFactory",h),d}if("function"==typeof define&&define.amd)define(["angular"],function(a){return b(a)});else{if(void 0===typeof a)throw new Error("Cannot bind dataDepend: AngularJS not available on window or via AMD");b(a)}}(angular);